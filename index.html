<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto 300</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0e27; color: #fff; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { font-size: 3rem; margin: 0; color: #8b9cdb; text-align: center; font-weight: 700; text-shadow: 0 2px 10px rgba(102, 126, 234, 0.3); letter-spacing: 2px; }
        .login-container { max-width: 400px; margin: 100px auto; text-align: center; background: #1a1f3a; padding: 40px; border-radius: 12px; border: 1px solid #2a3150; }
        .login-btn { background: #fff; color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 20px auto; }
        .stats { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card { background: #1a1f3a; padding: 20px 40px; border-radius: 12px; border: 1px solid #2a3150; }
        .stat-label { font-size: 0.9rem; color: #8b92b0; text-transform: uppercase; display: block; margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px 32px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .btn-logout { background: #ef4444; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; }
        .form-card { background: #1a1f3a; padding: 30px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #2a3150; display: none; }
        .form-card.active { display: block; }
        .form-section { margin: 20px 0; padding: 20px; background: #0f1425; border-radius: 8px; border-left: 4px solid #667eea; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 0.9rem; color: #8b92b0; }
        .form-group input { background: #0f1425; border: 1px solid #2a3150; padding: 12px; border-radius: 6px; color: white; font-size: 1rem; }
        .form-group input[type="date"] { color-scheme: dark; }
        .form-group input[type="date"]::-webkit-calendar-picker-indicator { 
            filter: invert(1) brightness(2);
            cursor: pointer;
            opacity: 1;
            background: transparent;
        }
        .form-group small { font-size: 0.8rem; color: #8b92b0; font-style: italic; }
        .btn-submit { background: #10b981; color: white; border: none; padding: 14px 40px; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; }
        .table-container { background: #1a1f3a; border-radius: 12px; overflow-x: auto; border: 1px solid #2a3150; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 8px 5px; text-align: center; font-weight: 600; border-bottom: 2px solid #2a3150; color: #8b92b0; text-transform: uppercase; font-size: 0.75rem; background: #0f1425; }
        .header-fulltbet { background: #fbbf24; color: #000; }
        .header-casab { background: #000000; color: #fbbf24; }
        .header-voucher { background: #a78bfa; color: #000; }
        td { padding: 8px 5px; text-align: center; border-bottom: 1px solid #2a3150; font-size: 0.9rem; }
        tr:hover { background: #1f2544; }

        tr:nth-child(even) { background: #151a2e; }
        tr:nth-child(odd) { background: #1a1f3a; }


        tr:nth-child(even) { background: #151a2e; }
        tr:nth-child(odd) { background: #1a1f3a; }

        .btn-action { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; margin: 0 5px; display: inline-block; vertical-align: middle; }
        .btn-edit { color: #3b82f6; }
        .empty-state { padding: 60px 20px; text-align: center; color: #8b92b0; }
        
        
        .monthly-summary { background: linear-gradient(135deg, #1a1f3a 0%, #2a3150 100%); border-radius: 16px; padding: 30px; border: 1px solid #3a4160; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .monthly-summary h2 { margin-bottom: 20px; color: #667eea; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
        .monthly-item { display: flex; justify-content: space-between; padding: 16px; background: #0f1425; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea; transition: all 0.3s; }
        .monthly-item:hover { background: #151a2e; transform: translateX(4px); }

        .monthly-summary h2 { margin-bottom: 20px; color: #667eea; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
        .monthly-item { display: flex; justify-content: space-between; padding: 16px; background: #0f1425; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea; transition: all 0.3s; }
        .monthly-item:hover { background: #151a2e; transform: translateX(4px); }

        .monthly-summary h2 { margin-bottom: 20px; color: #667eea; }
        .month-card { background: #0f1425; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center; }
        .month-name { font-size: 1.2rem; font-weight: 600; }
        .month-value { font-size: 1.5rem; font-weight: bold; }
        .user-info { text-align: right; margin-bottom: 20px; color: #8b92b0; display: flex; justify-content: flex-end; align-items: center; gap: 20px; }
        #app { display: none; }
        #login { display: block; }
        
        /* Estilos para edição inline de stake */
        .stake-edit-container { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .stake-display { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .stake-display:hover { background: #2a3150; }
        .stake-input { background: #0f1425; border: 1px solid #667eea; padding: 8px; border-radius: 6px; color: white; font-size: 0.95rem; width: 100px; text-align: center; }
        .stake-btn { background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; }
        .stake-btn-cancel { background: #ef4444; }
        .stake-edit-mode { display: flex; align-items: center; gap: 6px; }
        .voucher-badge { background: #a78bfa; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .header-pinnacle { background: linear-gradient(135deg, #1e3a8a 0%, #f97316 100%); color: #fff; }
        .header-betfair { background: linear-gradient(135deg, #000000 0%, #fbbf24 100%); color: #fff; }
        .form-group select { background: #0f1425; border: 1px solid #2a3150; padding: 12px; border-radius: 6px; color: white; font-size: 1rem; }
        .btn-settings { background: #667eea; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; }
        .header-pinnacle { background: linear-gradient(135deg, #1e3a8a 0%, #f97316 100%); color: #fff; }
        .header-betfair { background: linear-gradient(135deg, #000000 0%, #fbbf24 100%); color: #fff; }
        .form-group select { background: #0f1425; border: 1px solid #2a3150; padding: 12px; border-radius: 6px; color: white; font-size: 1rem; }
        .btn-settings { background: #667eea; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; }
    
        .tabs { display: flex; gap: 10px; margin: 30px 0 20px 0; border-bottom: 2px solid #2a3150; }
        .tab { padding: 12px 24px; background: transparent; border: none; color: #8b92b0; cursor: pointer; font-size: 1rem; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab:hover { color: #8b9cdb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stat-card { background: linear-gradient(135deg, #1a1f3a 0%, #2a3150 100%); border-radius: 16px; padding: 24px; border: 1px solid #3a4160; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); border-color: #667eea; }
        .stat-card h3 { font-size: 0.85rem; color: #8b92b0; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 2rem; font-weight: 700; margin: 0; }
        .stat-card .value.positive { color: #10b981; }
        .stat-card .value.negative { color: #ef4444; }

        
        .stat-card { background: linear-gradient(135deg, #1a1f3a 0%, #2a3150 100%); border-radius: 16px; padding: 24px; border: 1px solid #3a4160; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); border-color: #667eea; }
        .stat-card h3 { font-size: 0.85rem; color: #8b92b0; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 2rem; font-weight: 700; margin: 0; }
        .stat-card .value.positive { color: #10b981; }
        .stat-card .value.negative { color: #ef4444; }

        </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login">
        <div class="login-container">
            <h1>Projeto 300</h1>
            <p style="color: #8b92b0; margin: 20px 0;">Faça login para acessar seus dados</p>
            <button class="login-btn" onclick="loginWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <div class="container">
            <div class="user-info">
                <span id="userName"></span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
            <h1>Projeto 300</h1>
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-label">P/L Plataformas</span>
                    <span class="stat-value" id="plPlataformas">R$ 0,00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Vouchers</span>
                    <span class="stat-value" id="vouchersTotal">R$ 0,00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">P/L Real</span>
                    <span class="stat-value" id="plReal">R$ 0,00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Dias</span>
                    <span class="stat-value" id="diasCount">0</span>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn-primary" onclick="toggleForm()">+ Novo Dia</button>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dias')">📅 Dias Registrados</button>
            <button class="tab" onclick="switchTab('entradas')">🎯 Controle de Entradas</button>
        </div>

            </div>
            <form class="form-card" id="form" onsubmit="handleSubmit(event)">
                <h2 id="formTitle">Registrar Novo Dia</h2>
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="data" required>
                    </div>
                    <div class="form-group">
                        <label>Stake do Dia</label>
                        <input type="number" step="0.01" id="stakeDia" required>
                    </div>
                </div>
                <div class="form-section">
                    <h3>🟡 FULLTBET</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Saldo Início</label>
                            <input type="number" step="0.01" id="fulltbetInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Saldo Fim</label>
                            <input type="number" step="0.01" id="fulltbetFim">
                        </div>
                    </div>
                </div>
                                
<div class="form-section">
                    <h3>⚫ CASA B</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Saldo Início</label>
                            <input type="number" step="0.01" id="casaBInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Saldo Fim</label>
                            <input type="number" step="0.01" id="casaBFim">
                        </div>
                    </div>
                </div>
                <div class="form-section" style="border-left-color: #a78bfa;">
                    <h3>🎟️ VOUCHERS DE 50%</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantidade de Vouchers</label>
                            <input type="number" step="1" id="vouchers" value="0" min="0">
                            <small>Quantos vouchers de 50% da stake você ganhou hoje?</small>
                        </div>
                        <div class="form-group">
                            <label>Valor dos Vouchers</label>
                            <input type="text" id="vouchersValor" readonly style="background: #1a1f3a; cursor: not-allowed;">
                            <small>Calculado automaticamente: quantidade × stake × 0.5</small>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-submit">Salvar</button>
            </form>
            <div id="tab-dias" class="tab-content" style="display: block;">
        <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">DATA</th>
                            <th colspan="3" class="header-fulltbet">FULLTBET</th>
                            <th colspan="3" id="tableCasaBHeader" class="header-casab">CASA B</th>
                            <th rowspan="2">STAKE</th>
                            <th rowspan="2">P/L PLAT.</th>
                            <th colspan="2" class="header-voucher">VOUCHERS</th>
                            <th rowspan="2">P/L REAL</th>
                            <th rowspan="2">AÇÕES</th>
                        </tr>
                        <tr>
                            <th>Início</th>
                            <th>Fim</th>
                            <th>P/L</th>
                            <th>Início</th>
                            <th>Fim</th>
                            <th>P/L</th>
                            <th>Qtd</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <tr><td colspan="13" class="empty-state">Nenhum dia registrado</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="monthly-summary" id="monthlySummary" style="display:none;">
                <h2>📊 Resumo Mensal</h2>
                <div id="monthlyCards"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDjVDzkki4uOthiih4dzWHmuC6j3tZI8yA",
            authDomain: "projeto300-5b5ac.firebaseapp.com",
            projectId: "projeto300-5b5ac",
            storageBucket: "projeto300-5b5ac.firebasestorage.app",
            messagingSenderId: "806295962364",
            appId: "1:806295962364:web:421430b823be9ae43a0d79"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let dias = [];
        let editingStakeId = null;

        // Auth functions
        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('Erro ao fazer login: ' + error.message);
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                alert('Erro ao sair: ' + error.message);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userName').textContent = user.displayName;
                await loadDias();
            } else {
                currentUser = null;
                document.getElementById('login').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }
        });

        // Atualizar valor dos vouchers em tempo real
        document.getElementById('vouchers')?.addEventListener('input', updateVouchersValue);
        document.getElementById('stakeDia')?.addEventListener('input', updateVouchersValue);

        function updateVouchersValue() {
            const vouchers = parseInt(document.getElementById('vouchers').value) || 0;
            const stake = parseFloat(document.getElementById('stakeDia').value) || 0;
            const vouchersValor = vouchers * stake * 0.5;
            document.getElementById('vouchersValor').value = fmt(vouchersValor);
        }

        // Firestore functions
        async function loadDias() {
            const q = query(
                collection(db, 'dias'),
                where('userId', '==', currentUser.uid),
                orderBy('data', 'desc')
            );
            const querySnapshot = await getDocs(q);
            dias = [];
            querySnapshot.forEach((doc) => {
                dias.push({ id: doc.id, ...doc.data() });
            });
            render();
        }

        window.handleSubmit = async (e) => {
            e.preventDefault();
            const data = document.getElementById('data').value;
            const fi = parseFloat(document.getElementById('fulltbetInicio').value);
            const ffVal = document.getElementById('fulltbetFim').value;
            const ff = ffVal ? parseFloat(ffVal) : null;
            const bi = parseFloat(document.getElementById('casaBInicio').value);
            const bfVal = document.getElementById('casaBFim').value;
            const bf = bfVal ? parseFloat(bfVal) : null;
            const stake = parseFloat(document.getElementById('stakeDia').value);
            const vouchers = parseInt(document.getElementById('vouchers').value) || 0;
            
            const fpl = ff !== null ? ff - fi : null;
            const bpl = bf !== null ? bf - bi : null;
            const plPlataformas = (fpl !== null && bpl !== null) ? fpl + bpl : null;
            const vouchersValor = vouchers * stake * 0.5;
            const plReal = plPlataformas !== null ? plPlataformas + vouchersValor : null;

            const editId = document.getElementById('editId').value;

            const diaData = {
                userId: currentUser.uid,
                data,
                fi,
                ff,
                fpl,
                bi,
                bf,
                bpl,
                stake,
                vouchers,
                vouchersValor,
                plPlataformas,
                casaB: userCasaB,
                plReal
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'dias', editId), diaData);
                } else {
                    await addDoc(collection(db, 'dias'), diaData);
                }
                resetForm();
                toggleForm();
                await loadDias();
            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
            }
        };

        window.editDia = (id) => {
            const dia = dias.find(d => d.id === id);
            if (!dia) return;

            document.getElementById('editId').value = dia.id;
            document.getElementById('data').value = dia.data;
            document.getElementById('stakeDia').value = dia.stake;
            document.getElementById('fulltbetInicio').value = dia.fi;
            document.getElementById('fulltbetFim').value = dia.ff || '';
            document.getElementById('casaBInicio').value = dia.bi;
            document.getElementById('casaBFim').value = dia.bf || '';
            document.getElementById('vouchers').value = dia.vouchers || 0;
            document.getElementById('formTitle').textContent = 'Editar Dia';
            
            updateVouchersValue();
            document.getElementById('form').classList.add('active');
        };

        window.deleteDia = async (id) => {
            if (confirm('Excluir este registro?')) {
                try {
                    await deleteDoc(doc(db, 'dias', id));
                    await loadDias();
                } catch (error) {
                    alert('Erro ao excluir: ' + error.message);
                }
            }
        };

        // Funções de edição rápida de stake
        window.startEditStake = (id) => {
            editingStakeId = id;
            render();
        };

        window.cancelEditStake = () => {
            editingStakeId = null;
            render();
        };

        window.saveStake = async (id) => {
            const inputElement = document.getElementById(`stake-input-${id}`);
            const newStake = parseFloat(inputElement.value);
            
            if (isNaN(newStake) || newStake <= 0) {
                alert('Por favor, insira um valor válido para a stake');
                return;
            }

            const dia = dias.find(d => d.id === id);
            if (!dia) return;

            // Recalcular vouchers com nova stake
            const vouchers = dia.vouchers || 0;
            const vouchersValor = vouchers * newStake * 0.5;
            const plReal = dia.plPlataformas !== null ? dia.plPlataformas + vouchersValor : null;

            try {
                await updateDoc(doc(db, 'dias', id), { 
                    stake: newStake,
                    vouchersValor,
                    plReal
                });
                editingStakeId = null;
                await loadDias();
            } catch (error) {
                alert('Erro ao atualizar stake: ' + error.message);
            }
        };

        // Configuração de Casa B
        const casasConfig = {
            betbra: {
                name: 'CASA B',
                emoji: '🟢',
                headerClass: 'header-betbra',
                colors: { bg: '#10b981', text: '#000' }
            },
            pinnacle: {
                name: 'PINNACLE',
                emoji: '🔵',
                headerClass: 'header-pinnacle',
                colors: { bg: 'linear-gradient(135deg, #1e3a8a 0%, #f97316 100%)', text: '#fff' }
            },
            betfair: {
                name: 'BETFAIR',
                emoji: '⚫',
                headerClass: 'header-betfair',
                colors: { bg: 'linear-gradient(135deg, #000000 0%, #fbbf24 100%)', text: '#fff' }
            }
        };

        let userCasaB = 'betbra'; // Casa padrão

        window.updateCasaBSection = () => {
            const casaB = document.getElementById('casaB').value;
            const config = casasConfig[casaB];
            const title = document.getElementById('casaBTitle');
            const section = document.getElementById('casaBSection');
            
            title.textContent = `${config.emoji} ${config.name}`;
            userCasaB = casaB;
            
            // Atualizar labels dos inputs
            const labels = section.querySelectorAll('label');
            labels[0].textContent = 'Saldo Início';
            labels[1].textContent = 'Saldo Fim';
        };


        window.toggleForm = () => { 
            const form = document.getElementById('form');
            const isActive = form.classList.contains('active');
            
            if (isActive) {
                form.classList.remove('active');
                resetForm();
            } else {
                form.classList.add('active');
            }
        };

        function resetForm() {
            document.getElementById('form').reset();
            document.getElementById('editId').value = '';
            document.getElementById('vouchers').value = '0';
            document.getElementById('vouchersValor').value = '';
            document.getElementById('formTitle').textContent = 'Registrar Novo Dia';
        }

        function fmt(v) { 
            if (v === null || v === undefined || v === '') return '-';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); 
        }

        function fmtDate(d) { 
            const [y,m,day] = d.split('-'); 
            return day+'/'+m; 
        }

        function getMonthYear(d) { 
            const [y,m] = d.split('-'); 
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[parseInt(m)-1] + ' ' + y;
        }

        function renderMonthlySummary() {
            const monthlyData = {};
            
            dias.forEach(d => {
                if (d.plReal !== null) {
                    const monthYear = getMonthYear(d.data);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = 0;
                    }
                    monthlyData[monthYear] += d.plReal;
                }
            });

            const monthlyCards = document.getElementById('monthlyCards');
            const monthlySummary = document.getElementById('monthlySummary');

            if (Object.keys(monthlyData).length === 0) {
                monthlySummary.style.display = 'none';
                return;
            }

            monthlySummary.style.display = 'block';
            
            monthlyCards.innerHTML = Object.entries(monthlyData)
                .sort((a, b) => {
                    const [monthA, yearA] = a[0].split(' ');
                    const [monthB, yearB] = b[0].split(' ');
                    if (yearA !== yearB) return yearB - yearA;
                    const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                    return months.indexOf(monthB) - months.indexOf(monthA);
                })
                .map(([month, total]) => `
                    <div class="month-card">
                        <span class="month-name">${month}</span>
                        <span class="month-value ${total >= 0 ? 'positive' : 'negative'}">${fmt(total)}</span>
                    </div>
                `).join('');
        }

        function renderStakeCell(d) {
            if (editingStakeId === d.id) {
                return `
                    <td>
                        <div class="stake-edit-mode">
                            <input type="number" step="0.01" id="stake-input-${d.id}" class="stake-input" value="${d.stake}" onkeypress="if(event.key==='Enter') saveStake('${d.id}')">
                            <button class="stake-btn" onclick="saveStake('${d.id}')">✓</button>
                            <button class="stake-btn stake-btn-cancel" onclick="cancelEditStake()">✗</button>
                        </div>
                    </td>
                `;
            } else {
                return `
                    <td>
                        <div class="stake-edit-container">
                            <span class="stake-display" onclick="startEditStake('${d.id}')" title="Clique para editar">${fmt(d.stake)}</span>
                        </div>
                    </td>
                `;
            }
        }

        
        function switchTab(tabName) {
            // Atualizar botões
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mostrar/ocultar conteúdo
            document.getElementById('tab-dias').style.display = tabName === 'dias' ? 'block' : 'none';
            document.getElementById('tab-entradas').style.display = tabName === 'entradas' ? 'block' : 'none';
        }
        
        function openFormEntrada() {
            document.getElementById('formEntrada').classList.add('active');
            document.getElementById('formEntradaTitle').textContent = 'Registrar Nova Entrada';
        }
        
        function cancelEntrada() {
            document.getElementById('formEntrada').classList.remove('active');
            document.getElementById('entradaData').value = '';
            document.getElementById('entradaMercado').value = '';
            document.getElementById('entradaOddA').value = '';
            document.getElementById('entradaOddB').value = '';
            document.getElementById('entradaTipo').value = '';
            document.getElementById('entradaValorA').value = '';
            document.getElementById('entradaValorB').value = '';
        }

        function render() {
            const tbody = document.getElementById('tbody');
            
            // Calcular totais
            let totalPlataformas = 0;
            let totalVouchers = 0;
            let totalReal = 0;
            
            dias.forEach(d => {
                if (d.plPlataformas !== null) totalPlataformas += d.plPlataformas;
                if (d.vouchersValor !== null && d.vouchersValor !== undefined) totalVouchers += d.vouchersValor;
                if (d.plReal !== null) totalReal += d.plReal;
            });
            
            document.getElementById('plPlataformas').textContent = fmt(totalPlataformas);
            document.getElementById('plPlataformas').className = 'stat-value ' + (totalPlataformas >= 0 ? 'positive' : 'negative');
            
            document.getElementById('vouchersTotal').textContent = fmt(totalVouchers);
            document.getElementById('vouchersTotal').className = 'stat-value positive';
            
            document.getElementById('plReal').textContent = fmt(totalReal);
            document.getElementById('plReal').className = 'stat-value ' + (totalReal >= 0 ? 'positive' : 'negative');
            
            document.getElementById('diasCount').textContent = dias.length;
            
            if (dias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="empty-state">Nenhum dia registrado</td></tr>';
                
            
            // Atualizar cabeçalho da tabela com a casa B
            const headerCasaB = document.getElementById('tableCasaBHeader');
            if (headerCasaB && dias.length > 0) {
                const lastCasa = dias[0].casaB || 'betbra';
                const config = casasConfig[lastCasa];
                headerCasaB.textContent = config.name;
                headerCasaB.className = config.headerClass;
            }
renderMonthlySummary();
                return;
            }
            
            tbody.innerHTML = dias.map(d => {
                const vouchers = d.vouchers || 0;
                const vouchersValor = d.vouchersValor || 0;
                
                return `
                <tr>
                    <td>${fmtDate(d.data)}</td>
                    <td>${fmt(d.fi)}</td>
                    <td>${fmt(d.ff)}</td>
                    <td class="${d.fpl !== null ? (d.fpl >= 0 ? 'positive' : 'negative') : ''}">${fmt(d.fpl)}</td>
                    <td>${fmt(d.bi)}</td>
                    <td>${fmt(d.bf)}</td>
                    <td class="${d.bpl !== null ? (d.bpl >= 0 ? 'positive' : 'negative') : ''}">${fmt(d.bpl)}</td>
                    ${renderStakeCell(d)}
                    <td class="${d.plPlataformas !== null ? (d.plPlataformas >= 0 ? 'positive' : 'negative') : ''}" style="font-weight:bold;">${fmt(d.plPlataformas)}</td>
                    <td>${vouchers > 0 ? '<span class="voucher-badge">' + vouchers + '</span>' : '-'}</td>
                    <td class="positive" style="font-weight:600;">${vouchersValor > 0 ? fmt(vouchersValor) : '-'}</td>
                    <td class="${d.plReal !== null ? (d.plReal >= 0 ? 'positive' : 'negative') : ''}" style="font-weight:bold; font-size:1.1rem;">${fmt(d.plReal)}</td>
                    <td style="white-space: nowrap; padding: 8px;">
                        <button class="btn-action btn-edit" onclick="editDia('${d.id}')" title="Editar">✏️</button>
                        <button class="btn-action" onclick="deleteDia('${d.id}')" title="Excluir">🗑️</button>
                    </td>
                </tr>
            `}).join('');

            renderMonthlySummary();
            
            // Focus no input se estiver editando
            if (editingStakeId) {
                setTimeout(() => {
                    const input = document.getElementById(`stake-input-${editingStakeId}`);
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 50);
            }
        }
    
        // === FUNÇÕES DE ENTRADAS ===
        let currentEntradaId = null;
        
        window.switchTab = (tabName) => {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Mostrar aba selecionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'entradas') {
                loadEntradas();
            }
        };
        
        window.toggleFormEntrada = () => {
            const form = document.getElementById('formEntrada');
            const isActive = form.classList.contains('active');
            
            if (isActive) {
                form.classList.remove('active');
                resetFormEntrada();
            } else {
                form.classList.add('active');
                document.getElementById('entradaData').value = new Date().toISOString().split('T')[0];
            }
        };
        
        window.updateValorAField = () => {
            const tipo = document.getElementById('entradaTipo').value;
            const hint = document.getElementById('valorAHint');
            
            if (tipo === 'dinheiro') {
                hint.textContent = 'Usa a stake do dia';
            } else {
                hint.textContent = 'Valor do voucher';
            }
        };
        
        window.saveEntrada = async () => {
            if (!currentUser) return;
            
            const data = document.getElementById('entradaData').value;
            const mercado = document.getElementById('entradaMercado').value;
            const oddA = parseFloat(document.getElementById('entradaOddA').value);
            const oddB = parseFloat(document.getElementById('entradaOddB').value);
            const tipo = document.getElementById('entradaTipo').value;
            const valorA = parseFloat(document.getElementById('entradaValorA').value);
            const valorB = parseFloat(document.getElementById('entradaValorB').value);
            
            if (!data || !mercado || !oddA || !oddB || !valorA || !valorB) {
                alert('Preencha todos os campos!');
                return;
            }
            
            const entrada = {
                userId: currentUser.uid,
                data,
                mercado,
                oddA,
                oddB,
                tipo,
                valorA,
                valorB,
                timestamp: new Date().toISOString()
            };
            
            try {
                if (currentEntradaId) {
                    await updateDoc(doc(db, 'entradas', currentEntradaId), entrada);
                    alert('Entrada atualizada!');
                } else {
                    await addDoc(collection(db, 'entradas'), entrada);
                    alert('Entrada salva!');
                }
                
                toggleFormEntrada();
                loadEntradas();
            } catch (error) {
                console.error('Erro ao salvar entrada:', error);
                alert('Erro ao salvar entrada: ' + error.message);
            }
        };
        
        window.loadEntradas = async () => {
            if (!currentUser) return;
            
            try {
                const q = query(
                    collection(db, 'entradas'),
                    where('userId', '==', currentUser.uid),
                    orderBy('data', 'desc')
                );
                
                const snapshot = await getDocs(q);
                const entradas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderEntradas(entradas);
            } catch (error) {
                console.error('Erro ao carregar entradas:', error);
            }
        };
        
        function renderEntradas(entradas) {
            const tbody = document.getElementById('entradasList');
            
            if (entradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhuma entrada registrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = entradas.map(e => {
                const tipoLabel = e.tipo === 'dinheiro' ? '💵 Dinheiro' : '🎟️ Voucher';
                const tipoBadge = e.tipo === 'dinheiro' ? 
                    '<span style="background:#10b981;color:#000;padding:4px 8px;border-radius:4px;font-size:0.8rem;font-weight:600;">' + tipoLabel + '</span>' :
                    '<span style="background:#a78bfa;color:#000;padding:4px 8px;border-radius:4px;font-size:0.8rem;font-weight:600;">' + tipoLabel + '</span>';
                
                return `
                    <tr>
                        <td>${e.data.split('-').reverse().join('/')}</td>
                        <td style="font-weight:600;">${e.mercado}</td>
                        <td>${e.oddA.toFixed(2)}</td>
                        <td>${e.oddB.toFixed(2)}</td>
                        <td>${tipoBadge}</td>
                        <td>R$ ${e.valorA.toFixed(2)}</td>
                        <td>R$ ${e.valorB.toFixed(2)}</td>
                        <td style="white-space: nowrap; padding: 8px;">
                            <button class="btn-action btn-edit" onclick="editEntrada('${e.id}')" title="Editar">✏️</button>
                            <button class="btn-action" onclick="deleteEntrada('${e.id}')" title="Excluir">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        window.editEntrada = async (id) => {
            const docSnap = await getDoc(doc(db, 'entradas', id));
            if (!docSnap.exists()) return;
            
            const entrada = docSnap.data();
            currentEntradaId = id;
            
            document.getElementById('entradaData').value = entrada.data;
            document.getElementById('entradaMercado').value = entrada.mercado;
            document.getElementById('entradaOddA').value = entrada.oddA;
            document.getElementById('entradaOddB').value = entrada.oddB;
            document.getElementById('entradaTipo').value = entrada.tipo;
            document.getElementById('entradaValorA').value = entrada.valorA;
            document.getElementById('entradaValorB').value = entrada.valorB;
            
            document.getElementById('formEntradaTitle').textContent = 'Editar Entrada';
            document.getElementById('formEntrada').classList.add('active');
        };
        
        window.deleteEntrada = async (id) => {
            if (!confirm('Tem certeza que deseja excluir esta entrada?')) return;
            
            try {
                await deleteDoc(doc(db, 'entradas', id));
                alert('Entrada excluída!');
                loadEntradas();
            } catch (error) {
                console.error('Erro ao excluir entrada:', error);
                alert('Erro ao excluir entrada: ' + error.message);
            }
        };
        
        function resetFormEntrada() {
            currentEntradaId = null;
            document.getElementById('formEntradaTitle').textContent = 'Registrar Nova Entrada';
            document.getElementById('entradaData').value = '';
            document.getElementById('entradaMercado').value = '';
            document.getElementById('entradaOddA').value = '';
            document.getElementById('entradaOddB').value = '';
            document.getElementById('entradaTipo').value = 'dinheiro';
            document.getElementById('entradaValorA').value = '';
            document.getElementById('entradaValorB').value = '';
        }

        </script>
</body>
</html>

